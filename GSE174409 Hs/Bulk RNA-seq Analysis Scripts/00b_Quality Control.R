# Comprehensive Bulk RNA-seq QC for GSE174409 Hs
# ------------------------------------------------------------

# Load required libraries
library(dplyr)
library(edgeR)
library(limma)
library(RColorBrewer)
library(pheatmap)
library(ggplot2)
library(gridExtra)

# Set directories
base_dir <- "/GSE174409 Hs"
raw_dir <- file.path(base_dir, "Data")
qc_dir <- file.path(base_dir, "QC")
qc_vis_dir <- file.path(base_dir, "QC_Visualizations")
dir.create(qc_vis_dir, showWarnings = FALSE)

# ----------------------
# 1. LOAD PREPROCESSED DATA
# ----------------------

# Load data from fixed file locations generated by 00_Metadata.R
dge_filtered <- readRDS(file.path(qc_dir, "dge_filtered_normalized.rds"))
metadata_df <- readRDS(file.path(qc_dir, "metadata.rds"))
logcpm_filtered_norm <- readRDS(file.path(qc_dir, "logcpm_filtered_normalized.rds"))

# Extract counts and log-CPM for QC
counts <- dge_filtered$counts
logcpm <- logcpm_filtered_norm

# Display dimensions and preview to verify Ensembl IDs are preserved
cat("Expression matrix dimensions:", dim(counts), "\n")
cat("First few gene IDs (should be Ensembl IDs):\n")
print(head(rownames(counts)))

cat("\nMetadata columns:\n")
print(colnames(metadata_df))
print(head(metadata_df))

# Ensure factors are properly set
metadata_df$diagnosis <- factor(metadata_df$diagnosis, levels = c("CONT", "OUD"))
metadata_df$region <- factor(metadata_df$region, levels = c("NAC", "DLPFC"))
if("sex" %in% colnames(metadata_df)) {
  metadata_df$sex <- factor(metadata_df$sex)
}

# ----------------------
# 2. GENE-LEVEL QC
# ----------------------

# Calculate gene stats using the already filtered data
gene_stats <- data.frame(
  gene_id = rownames(counts),
  mean_count = rowMeans(counts),
  median_count = apply(counts, 1, median),
  min_count = apply(counts, 1, min),
  max_count = apply(counts, 1, max),
  zero_samples = rowSums(counts == 0),
  pct_zeros = rowSums(counts == 0) / ncol(counts) * 100
)

# Save gene stats
write.csv(gene_stats, file.path(qc_vis_dir, "gene_stats.csv"), row.names = FALSE)

# Plot gene expression distribution
png(file.path(qc_vis_dir, "gene_expression_distribution.png"), width = 1000, height = 800)
hist(log10(gene_stats$mean_count + 1), breaks = 100,
     xlab = "log10(mean count + 1)", main = "Gene Expression Distribution (Filtered Genes)")
abline(v = log10(10), col = "red", lwd = 2, lty = 2)
dev.off()

# ----------------------
# 3. SAMPLE-LEVEL QC
# ----------------------

# Calculate library sizes
lib_sizes <- colSums(counts)
metadata_df$lib_size <- lib_sizes

# Plot library sizes
png(file.path(qc_vis_dir, "library_sizes.png"), width = 1000, height = 800)
barplot(lib_sizes/1e6, names.arg = metadata_df$sample_id, las = 2, cex.names = 0.7,
        main = "Library Sizes", ylab = "Millions of Reads", col = as.numeric(metadata_df$diagnosis))
abline(h = mean(lib_sizes/1e6), col = "red", lwd = 2, lty = 2)
legend("topright", legend = levels(metadata_df$diagnosis), fill = 1:length(levels(metadata_df$diagnosis)))
dev.off()

# Boxplot of log CPM values
png(file.path(qc_vis_dir, "log_cpm_boxplot.png"), width = 1200, height = 800)
boxplot(logcpm, las = 2, col = as.numeric(metadata_df$diagnosis),
        main = "Log2 CPM Distribution", cex.axis = 0.7)
legend("topright", legend = levels(metadata_df$diagnosis),
       fill = 1:length(levels(metadata_df$diagnosis)))
dev.off()

# Density plot of log CPM values
png(file.path(qc_vis_dir, "log_cpm_density.png"), width = 1000, height = 800)
plotDensities(logcpm, col = as.numeric(metadata_df$diagnosis),
              legend = "topright", main = "Log2 CPM Density")
legend("topright", legend = levels(metadata_df$diagnosis),
       fill = 1:length(levels(metadata_df$diagnosis)))
dev.off()

# Sample correlation heatmap
sample_cor <- cor(logcpm)
annotation_col <- data.frame(
  Diagnosis = metadata_df$diagnosis,
  Region = metadata_df$region,
  row.names = metadata_df$sample_id
)

# Define colors for annotation
ann_colors <- list(
  Diagnosis = c("CONT" = "blue", "OUD" = "red"),
  Region = c("NAC" = "purple", "DLPFC" = "green")
)

png(file.path(qc_vis_dir, "sample_correlation_heatmap.png"), width = 1200, height = 1000)
pheatmap(sample_cor, annotation_col = annotation_col, annotation_colors = ann_colors,
         show_colnames = FALSE, main = "Sample Correlation")
dev.off()

# ----------------------
# 4. EXPLORATORY DATA ANALYSIS
# ----------------------

# MDS plot
png(file.path(qc_vis_dir, "mds_plot.png"), width = 1000, height = 800)
par(mfrow = c(1, 2))
# MDS by diagnosis
plotMDS(dge_filtered, col = as.numeric(metadata_df$diagnosis), main = "MDS by Diagnosis")
legend("topright", legend = levels(metadata_df$diagnosis),
       col = 1:length(levels(metadata_df$diagnosis)), pch = 16)
# MDS by region
plotMDS(dge_filtered, col = as.numeric(metadata_df$region), main = "MDS by Region")
legend("topright", legend = levels(metadata_df$region),
       col = 1:length(levels(metadata_df$region)), pch = 16)
dev.off()

# PCA analysis
pca_res <- prcomp(t(logcpm))
variance_explained <- (pca_res$sdev^2) / sum(pca_res$sdev^2) * 100

# PCA plot by diagnosis and region
pca_data <- data.frame(
  PC1 = pca_res$x[,1],
  PC2 = pca_res$x[,2],
  PC3 = pca_res$x[,3],
  Diagnosis = metadata_df$diagnosis,
  Region = metadata_df$region
)

# Add sex if available
if("sex" %in% colnames(metadata_df)) {
  pca_data$Sex <- metadata_df$sex
}

png(file.path(qc_vis_dir, "pca_diagnosis_region.png"), width = 1200, height = 600)
par(mfrow = c(1, 2))
# PCA by diagnosis
plot(pca_data$PC1, pca_data$PC2, col = as.numeric(pca_data$Diagnosis),
     pch = 16, cex = 1.5,
     xlab = paste0("PC1 (", round(variance_explained[1], 2), "%)"),
     ylab = paste0("PC2 (", round(variance_explained[2], 2), "%)"),
     main = "PCA - Diagnosis")
legend("topright", legend = levels(pca_data$Diagnosis),
       col = 1:length(levels(pca_data$Diagnosis)), pch = 16)

# PCA by region
plot(pca_data$PC1, pca_data$PC2, col = as.numeric(pca_data$Region),
     pch = 16, cex = 1.5,
     xlab = paste0("PC1 (", round(variance_explained[1], 2), "%)"),
     ylab = paste0("PC2 (", round(variance_explained[2], 2), "%)"),
     main = "PCA - Brain Region")
legend("topright", legend = levels(pca_data$Region),
       col = 1:length(levels(pca_data$Region)), pch = 16)
dev.off()

# ----------------------
# 5. BATCH EFFECT ASSESSMENT
# ----------------------

# Check for potential batch effects from other metadata
if("pmi" %in% colnames(metadata_df)) {
  # Categorize PMI into groups for visualization
  metadata_df$pmi_group <- cut(metadata_df$pmi,
                              breaks = quantile(metadata_df$pmi, probs = seq(0, 1, 0.25), na.rm = TRUE),
                              labels = c("Low", "Medium-low", "Medium-high", "High"),
                              include.lowest = TRUE)

  # PCA plot by PMI
  png(file.path(qc_vis_dir, "pca_pmi_effect.png"), width = 800, height = 800)
  plot(pca_data$PC1, pca_data$PC2, col = as.numeric(metadata_df$pmi_group),
       pch = 16, cex = 1.5,
       xlab = paste0("PC1 (", round(variance_explained[1], 2), "%)"),
       ylab = paste0("PC2 (", round(variance_explained[2], 2), "%)"),
       main = "PCA - PMI Effect")
  legend("topright", legend = levels(metadata_df$pmi_group),
         col = 1:length(levels(metadata_df$pmi_group)), pch = 16)
  dev.off()
}

# ----------------------
# 6. SUMMARY REPORT
# ----------------------
sink(file.path(qc_vis_dir, "preprocessing_summary.txt"))
cat("=== BULK RNA-SEQ PREPROCESSING SUMMARY ===\n\n")
cat("Total samples:", ncol(counts), "\n")
cat("Filtered genes:", nrow(counts), "\n")
cat("Normalization method: TMM\n\n")

cat("=== GENE IDs ===\n")
cat("Type: Ensembl IDs\n")
cat("Examples:", paste(head(rownames(counts), 5), collapse=", "), "...\n\n")

cat("=== SAMPLE GROUPS ===\n")
print(table(metadata_df$diagnosis, metadata_df$region))
cat("\n")

if("sex" %in% colnames(metadata_df)) {
  print(table(metadata_df$diagnosis, metadata_df$sex))
  cat("\n")
}

cat("=== LIBRARY SIZE STATS ===\n")
print(summary(lib_sizes))
cat("\n")

cat("=== TOP PC VARIANCE EXPLAINED ===\n")
print(data.frame(PC = 1:5,
                Variance = variance_explained[1:5],
                Cumulative = cumsum(variance_explained)[1:5]))
sink()

cat("QC analysis complete. Visualizations saved in:", qc_vis_dir, "\n")
cat("Ensembl IDs preserved in all data files\n")